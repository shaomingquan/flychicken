<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>demo</title>
    <script src="./node_modules/matter-js/build/matter.min.js" charset="utf-8"></script>
    <script src="./world.js" charset="utf-8"></script>
    <script src="./hero.js" charset="utf-8"></script>
    <script src="./bullet.js" charset="utf-8"></script>
    <script src="./controller.js" charset="utf-8"></script>
    <style media="screen">
      html, body {
        height: 100%;
        width: 100%;
        padding: 0;
        margin: 0;
      }
    </style>
  </head>
  <body>

    <script type="text/javascript">

// /demo/#collisionFiltering 这个例子可以用来开启隐身
// /demo/#airFriction 这个例子可做减速的debuff
// /demo/#events 这个例子用来做子弹撞击
// 用颜色代表血量
// 同步子弹数据的时候实际上是同步子弹的初始位置

// 出生点区域，玩家坐标，障碍物密度

      // module aliases
      window.E = {}; // global engine

      E.Engine = Matter.Engine,
      E.Render = Matter.Render,
      E.World = Matter.World,
      E.Bodies = Matter.Bodies;
      E.Body = Matter.Body;
      E.Events = Matter.Events;
      E.Bounds = Matter.Bounds;
      E.Mouse = Matter.Mouse;


      // create an engine
      var engine = E.Engine.create();
      var w = engine.world;

      const world = new World ({
        E,
        _instance: w,
        engine,
        metrics: {
          height: 2000,
          width: 2000,
          vPortHeight: 800,
          vPortWidth: 1000,
          thicknessOfBound: 20
        }
      })


      // mouse event
      // window.mouse = Mouse.create(render.canvas)


      const heroA = new Hero({
        E,
        world,
        metrics: false, // default
        posi: {
          x: 400,
          y: 200
        }
      })

      const heroB = new Hero({
        E,
        world,
        metrics: false, // default
        posi: {
          x: 200,
          y: 400
        }
      })

      heroA.joinWorld();
      heroB.joinWorld();
      world.lockon(heroA);

      const controller = new Controller({
        E,
        world,
        metrics: {}
      })
      controller.addControlTo(heroA)


      // Events.on(engine, 'beforeUpdate', function(event) {
      //
      //
      //   var aposi = window.mouse.absolute;
      //   window.viewOffsetX = (aposi.x - viewportCentre.x) / 3;
      //   window.viewOffsetY = (aposi.y - viewportCentre.y) / 3;
      //
      //
      //   yourPositionAbs.x = viewportCentre.x + window.viewOffsetX;
      //   yourPositionAbs.y = viewportCentre.y + window.viewOffsetY;
      //
      //   var www = aposi.x - yourPositionAbs.x;
      //   var hhh = aposi.y - yourPositionAbs.y;
      //   var ang = Math.atan(hhh / www)
      //   Body.setAngle(window.boxA, ang)
      //   // Fallow Hero X
      //   render.bounds.min.x = boxA.position.x - cWidth / 2 + viewOffsetX;
      //   render.bounds.max.x = boxA.position.x + cWidth / 2 + viewOffsetX;
      //
      //   // Fallow Hero Y
      //   render.bounds.min.y = boxA.position.y - cHeight / 2 + viewOffsetY;
      //   render.bounds.max.y = boxA.position.y + cHeight / 2 + viewOffsetY;
      //
      //   // Body.setVelocity(boxA, {x: vX / 2, y: vY / 2})
      // })
/*
      function scaletounithhhwww (hhh, www) {
        var diagonal = Math.sqrt(hhh**2 + www**2)
        return {
          unith: (hhh / diagonal) * 2.5 * myr,
          unitw: (www / diagonal) * 2.5 * myr
        }
      }

      var bullets = [];
      document.addEventListener('click', function () {
        var aposi = window.mouse.absolute;
        var www = aposi.x - yourPositionAbs.x;
        var hhh = aposi.y - yourPositionAbs.y;

        var angle = Math.atan(hhh / www)

        var { unith, unitw } = scaletounithhhwww(hhh, www);

        bulletposistart  = {
          x: window.boxA.position.x + unitw,
          y: window.boxA.position.y + unith
        }

        var bullet = Bodies.rectangle(bulletposistart.x, bulletposistart.y, myr, 3, {angle})
        // Body.setMass(bullet, 0.0001)
        bullet.render.fillStyle = 'aqua'
        Body.setVelocity(bullet, {x: unitw * unitv, y: unith * unitv})
        // bullets.push(bullet)
        var timer = setTimeout(function() {
          World.remove(engine.world, bullet)
          clearTimeout(timer)
        }, 3000)

        World.add(engine.world, [bullet])
      })

      var canvasEle = document.getElementsByTagName('canvas')[0]
      // var cWidth = canvasEle.width * 2;
      // var cHeight = canvasEle.height * 2;
      var cWidth = canvasEle.width;
      var cHeight = canvasEle.height;
      var viewportCentre = {
        x: render.options.width * 0.5,
        y: render.options.height * 0.5
      };

      var yourPositionAbs = Object.assign({}, viewportCentre);

*/
      // run the engine
      E.Engine.run(world.engine);

      // run the renderer
      E.Render.run(world.render);
    </script>
  </body>
</html>
